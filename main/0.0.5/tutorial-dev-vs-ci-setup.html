<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled :: Talend Component Kit Developer Reference Guide</title>
    <link rel="canonical" href="https://talend.github.io/component-runtime/main/1.0.1/tutorial-dev-vs-ci-setup.html">
    <meta name="generator" content="Antora 1.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
<meta name="date" content="2018-06-06T12:02:39.699Z" scheme="YYYY-MM-DDTHH:mm:ss.sssZ">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha256-NuCn4IvuZXdBaFKJOAcsU2Q3ZpwbdFisd5dux4jkQ5w=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/2.8.0/instantsearch.min.css" integrity="sha256-vusmcqkVvKdkwoueSJZLlO9y2P+Lp9fN3WwQUV9Uwfw=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/2.8.0/instantsearch-theme-algolia.min.css" integrity="sha256-ZqsS4QagZnfArbOyheCO4qVjzzsMbg/WMvf5tLtId/Q=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/idea.min.css" integrity="sha256-rD61BPsgKHzJPyg7vpXaYOw6tMYuY2fz1p9033NYeM8=" crossorigin="anonymous" />
<link rel="stylesheet" href="../../_/css/talend.css">
<link rel="shortcut icon" href="../../_/images/favicon_0.ico" />    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PSBN"></script>
    <script>dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','GTM-PSBN')</script>
  </head>
  <body class="article">
<header class="header" role="banner">
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="navbar-item">
                <a href="https://talend.github.io/component-runtime">Talend Component Kit</a>
                <span class="separator">//</span>
                <a href="https://talend.github.io/component-runtime">Docs</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="global-search">
                    <form role="search" action="search.html">
                        <div>
                            <input class="rounded" type="text" placeholder="Search" name="query" id="searchInput">
                            <input type="hidden" name="idx" value="githubantora">
                        </div>
                    </form>
                </div>
                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Projects</div>
                    <div class="navbar-dropdown">
                        <div class="navbar-item"><strong>API</strong></div>
                        <a class="navbar-item" href="https://github.com/talend/component-api">Repository</a>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><strong>Runtime</strong></div>
                        <a class="navbar-item" href="https://github.com/talend/component-rutime">Repository</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="main" data-version="0.0.5">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Talend Component Kit Developer Reference Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Programming Model</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-definition.html">Definition Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-registering.html">Registration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="gallery.html">Widget Gallery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-internationalization.html">Labels and i18n</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-loading.html">Loading</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Build</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="build-tools-maven.html">Maven</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="build-tools-gradle.html">Gradle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Services</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-internationalization.html">Internationalization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-actions.html">Actions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-built-in.html">Built-in services</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-interceptors.html">Interceptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-custom-api.html">Extend the API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Execute</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-pipeline.html">Simple/Test Pipeline API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://beam.apache.org/documentation/programming-guide/#creating-a-pipeline">Beam Pipeline API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Testing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-best-practices.html">JUnit Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-junit.html">Testing HTTP API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-beam.html">Beam case</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-spark.html">Spark and JUnit</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-multiple-envs.html">Multiple environments for the same tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-maven-passwords.html">Secrets/Passwords and Maven</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-generating-data.html">Generating data?</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Web</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="documentation-rest.html">Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-generate-project-using-starter.html">Generate a component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-an-input-component.html">Create an input component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-an-output-component.html">Create an output component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-test-your-components.html">Test your components</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-configuration-sensitive-data.html">Configuration and sensitive data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-components-rest-api.html">Create components for REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-test-rest-api.html">How to test a REST API</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="tutorial-dev-vs-ci-setup.html">Dev vs CI setup</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Talend Component Kit Developer Reference Guide</span>
    <span class="version">0.0.5</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Talend Component Kit Developer Reference Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../1.0.1/index.html">1.0.1</a>
        </li>
        <li class="version">
          <a href="../1.0.0/index.html">1.0.0</a>
        </li>
        <li class="version">
          <a href="../0.0.12/index.html">0.0.12</a>
        </li>
        <li class="version">
          <a href="../0.0.11/index.html">0.0.11</a>
        </li>
        <li class="version">
          <a href="../0.0.10/index.html">0.0.10</a>
        </li>
        <li class="version">
          <a href="../0.0.9/index.html">0.0.9</a>
        </li>
        <li class="version">
          <a href="../0.0.8/index.html">0.0.8</a>
        </li>
        <li class="version">
          <a href="../0.0.7/index.html">0.0.7</a>
        </li>
        <li class="version">
          <a href="../0.0.6/index.html">0.0.6</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.0.5</a>
        </li>
        <li class="version">
          <a href="../0.0.4/index.html">0.0.4</a>
        </li>
        <li class="version">
          <a href="../0.0.3/index.html">0.0.3</a>
        </li>
        <li class="version">
          <a href="../0.0.2/index.html">0.0.2</a>
        </li>
        <li class="version">
          <a href="../0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
    <button class="navigation-toggle"></button>
    <nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Talend Component Kit Developer Reference Guide</a></li>
    <li class="crumb">Tutorials</li>
    <li class="crumb"><a href="tutorial-dev-vs-ci-setup.html">Dev vs CI setup</a></li>
  </ul>
</nav>
    <div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">0.0.5</button>
  <div class="versions-menu">
    <a class="version" href="../1.0.1/tutorial-dev-vs-ci-setup.html">1.0.1</a>
    <a class="version" href="../1.0.0/tutorial-dev-vs-ci-setup.html">1.0.0</a>
    <a class="version" href="../0.0.12/tutorial-dev-vs-ci-setup.html">0.0.12</a>
    <a class="version" href="../0.0.11/tutorial-dev-vs-ci-setup.html">0.0.11</a>
    <a class="version" href="../0.0.10/tutorial-dev-vs-ci-setup.html">0.0.10</a>
    <a class="version" href="../0.0.9/tutorial-dev-vs-ci-setup.html">0.0.9</a>
    <a class="version" href="../0.0.8/tutorial-dev-vs-ci-setup.html">0.0.8</a>
    <a class="version" href="../0.0.7/tutorial-dev-vs-ci-setup.html">0.0.7</a>
    <a class="version" href="../0.0.6/tutorial-dev-vs-ci-setup.html">0.0.6</a>
    <a class="version is-current" href="tutorial-dev-vs-ci-setup.html">0.0.5</a>
    <a class="version" href="../0.0.4/tutorial-dev-vs-ci-setup.html">0.0.4</a>
    <a class="version" href="../0.0.3/tutorial-dev-vs-ci-setup.html">0.0.3</a>
    <a class="version" href="../0.0.2/tutorial-dev-vs-ci-setup.html">0.0.2</a>
    <a class="version is-missing" href="../0.0.1/index.html">0.0.1</a>
  </div>
</div>
</div>
<article class="doc">
        <div class="paragraph">
<p>Development vs Continuous integration Setup</p>
</div>
<div id="tutorial-dev-vs-ci-setup.adoc" class="paragraph">
<p><a href="tutorial-test-rest-api.html" class="page">In a previous tutorial</a>, we have shown how to create a mocked test for our Zendesk search component.</p>
</div>
<div class="paragraph">
<p>In the test you can notice that we have used our Zendesk credentials directly into the code to do a first capture of the API response,
then we have switched to a fake credentials in simulation mode as we do not call the real API anymore.</p>
</div>
<div class="paragraph">
<p><strong>But what if you want to continue to call the real API on the CI server or on a a specific environment ?</strong></p>
</div>
<div class="paragraph">
<p>Let&#8217;s make our test able to get the credentials depending on the execution mode (simulation/passthrough).</p>
</div>
<div class="sect1">
<h2 id="_credentials_setup"><a class="anchor" href="#_credentials_setup"></a>1. Credentials setup</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This instructions, need to be done, on the CI server or on any environment that require the real credentials.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will use <a href="https://maven.apache.org/guides/mini/guide-encryption.html">Maven servers, that support password encryption</a> as a credentials provider,
and the test rule <code>MavenDecrypterRule</code> provided by the framework.</p>
</div>
<div class="paragraph">
<p>This rule let you get credentials from maven settings using a server id.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s create an encrypted server credential for our zendesk instance.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a master password using the command : <code>mvn --encrypt-master-password &lt;password&gt;</code></p>
</li>
<li>
<p>Store this master password in <code>settings-security.xml</code> file  in <code>~/.m2</code> folder.</p>
</li>
<li>
<p>Encrypt zendesk instance password using the command: <code>mvn --encrypt-password &lt;zendesk-password&gt;</code></p>
</li>
<li>
<p>Create a server entry under <strong>servers</strong> in maven <code>settings.xml</code> file in <code>~/.m2</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>    &lt;server&gt;
      &lt;id&gt;zendesk&lt;/id&gt;
      &lt;username&gt;username@email.com&lt;/username&gt;
      &lt;password&gt;The enccrypted password {oL37x/xiSvwtlhrMQ=}&lt;/password&gt;
    &lt;/server&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Encryption is optional but recommended.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to store the <code>settings-security.xml</code> and <code>settings.xml</code> files elsewhere that the default location <code>~/.m2</code>.
You can do it by setting the path of the directory containing the files
into the environment variable  <code>talend.maven.decrypter.m2.location</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_let_s_adapt_our_unit_test_to_use_the_credentials_from_maven_servers"><a class="anchor" href="#_let_s_adapt_our_unit_test_to_use_the_credentials_from_maven_servers"></a>2. Let&#8217;s adapt our unit test to use the credentials from maven servers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We start by adding <code>MavenDecrypterRule</code> rule to our test class. This rule will let us inject server information stored
in maven settings.xml to our test. The rule will also decrypt the password if they are encrypted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SearchTest {

    @Rule
    public final MavenDecrypterRule mavenDecrypterRule = new MavenDecrypterRule(this);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can inject our Zendesk server to our test. For that we add a new field to our class annotated by <code>@DecryptedServer</code>
annotation that will holde the server id to be injected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SearchTest {

    @Rule
    public final MavenDecrypterRule mavenDecrypterRule = new MavenDecrypterRule(this);

    @DecryptedServer("zendesk")
    private Server server;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MavenDecrypterRule</code> will be able at runtime to inject the server instance into this class. the server instance contains
the username and de decrypted password.</p>
</div>
<div class="paragraph">
<p>Now we can use the <code>server</code> instance in our test to get the real credential in a secured manner.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BasicAuth basicAuth = new BasicAuth("https://instance.zendesk.com",
                            server.getUsername(),
                            server.getPassword());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the complete test class after modification :</p>
</div>
<div class="listingblock initial-block-closed">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SearchTest {

    @ClassRule
    public static final SimpleComponentRule component = new SimpleComponentRule("component.package");

    private final MavenDecrypter mavenDecrypter = new MavenDecrypter();

    @ClassRule
    public static final JUnit4HttpApi API = new JUnit4HttpApi()
                                                        .activeSsl();

    @Rule
    public final JUnit4HttpApiPerMethodConfigurator configurator = new JUnit4HttpApiPerMethodConfigurator(API);

    @Rule
    public final MavenDecrypterRule mavenDecrypterRule = new MavenDecrypterRule(this);

    @DecryptedServer("zendesk")
    private Server server;

    @Test
    public void searchQuery() {
        // Initiating the component test configuration
        BasicAuth basicAuth = new BasicAuth("https://instance.zendesk.com", server.getUsername(), server.getPassword());
        final SearchQuery searchQuery = new SearchQuery(basicAuth, "type:ticket status:open", "created_at", "desc");

        // We convert our configuration instance to URI configuration
        final String uriConfig = SimpleFactory.configurationByExample()
                        .forInstance(searchQuery)
                        .configured().toQueryString();

        // We create our job test pipeline
        Job.components()
                .component("search", "zendesk://search?" + uriConfig)
                .component("collector", "test://collector")
                .connections()
                .from("search").to("collector")
                .build()
                .run();

        final List&lt;JsonObject&gt; res = component.getCollectedData(JsonObject.class);
        assertEquals(4, res.size());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>This test will continue to work in simulation mode.</strong> as we have our API simulation proxy activated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_up_ci_server_in_passthrough_mode"><a class="anchor" href="#_set_up_ci_server_in_passthrough_mode"></a>3. Set up CI server in passthrough mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s make it work in real mode on a CI server. we will use <a href="https://jenkins.io/">jenkins</a> in this tutorial</p>
</div>
<div class="paragraph">
<p>Log in to your jenkins then : Click on <strong>New Item</strong> to create a new build job</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jenkins/1_jenkins_new_item.png" alt="Create a new job">
</div>
</div>
<div class="paragraph">
<p>Enter an Item name (Job name) and choose the freestyle job. Then click OK.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jenkins/2_jenkins_new_item.png" alt="Create a new job">
</div>
</div>
<div class="paragraph">
<p>In <strong>Source Code Management</strong> section enter your project repository URL. We are using our github repository in this tutorial.
We will build the <code>master</code> branch</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jenkins/4_jenkins_source_code.png" alt="Source Code Management">
</div>
</div>
<div class="paragraph">
<p>In the <strong>Build Section</strong> click on <strong>add build step</strong>, then choose <strong>Invoke top-level Maven targets</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jenkins/6_jenkins_build_cmd.png" alt="Build Section">
</div>
</div>
<div class="paragraph">
<p>Choose you Maven version, and enter your maven build command. we are using a simple <code>clean install</code> and click <strong>save</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jenkins/6_jenkins_build_cmd_2.png" alt="Build Section">
</div>
</div>
<div class="paragraph">
<p>You can notice that we have added the option <code>-Dtalend.junit.http.passthrough=true</code> to our build command.
This Option will tell the API simulation proxy to run in <code>passthrough</code> mode. So it&#8217;s will forward all the http request
that we have maded in our test to the real API server.</p>
</div>
<div class="paragraph">
<p>We also get the real credentials, thanks to our <code>MavenDecrypterRule</code> rule.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can configure the <strong>passthrough</strong> mode globally on your CI server by setting the environment variable <code>talend.junit.http.passthrough</code>
to <code>true</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>6.Test the job. click <strong>Build now</strong> you can notice that your job have built correctly.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jenkins/7_jenkins_build_result.png" alt="Test the job">
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all you need to do, now your tests run in a simulation mode on dev and in a (passthrough) mode on your CI server.</p>
</div>
</div>
</div>
    </article>
  </main>
</div>
<footer class="footer">
    <div class="footer-with-copyright footer-with-links">
        <ul class="footer-links" style="">
            <li><a class="gwt-Anchor" href="http://www.talend.com/">Talend</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/contact">Contact</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/legal-terms/us-eula">Talend EULA</a></li>
        </ul>
        <div class="footer-copyright" style="">&copy; 2018 Talend Inc. All rights reserved.</div>
    </div>
</footer>
<script src="../../_/js/site.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script>hljs.initHighlighting()</script>
<script>
(function (window, document) {
  var closedSize = '50px';
  document.querySelectorAll('.listingblock')
    .forEach(function (listingblock, index) {
      var pre = listingblock.querySelector('div.content > pre.highlightjs.highlight');
      if (!pre) {return;}
      var code = pre.querySelector('code.hljs');
      if (!code) {return;}

      var span = document.createElement('span');
      var initialBlockClosed = listingblock.className.indexOf('initial-block-closed') >= 0;
      span.className = 'code-' + (initialBlockClosed ? 'collapsed' : 'open') + '-handle code-handle-base';

      var height = code.style.height;
      if (initialBlockClosed) {code.style.height = closedSize;}

      span.addEventListener('click', function () {
        if (span.className == 'code-collapsed-handle code-handle-base') {
          code.style.height = height;
          span.className = 'code-open-handle code-handle-base';
        } else {
          code.style.height = closedSize;
          span.className = 'code-collapsed-handle code-handle-base';
        }
      }, false);

      pre.prepend(span);
    });
})(window, document);
</script>
  </body>
</html>
