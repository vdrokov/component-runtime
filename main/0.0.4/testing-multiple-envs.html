<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple environments for the same tests :: Talend Component Kit Developer Reference Guide</title>
    <link rel="canonical" href="https://talend.github.io/component-runtime/main/1.0.1/testing-multiple-envs.html">
    <meta name="generator" content="Antora 1.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
<meta name="date" content="2018-05-28T16:05:41.480Z" scheme="YYYY-MM-DDTHH:mm:ss.sssZ">
<link rel="stylesheet" href="../../_/css/instantsearch.min.css">
<link rel="stylesheet" href="../../_/css/instantsearch-theme-algolia.min.css">
<link rel="stylesheet" href="../../_/css/idea.css">
<link rel="stylesheet" href="../../_/css/talend.css">
<link rel="shortcut icon" href="../../_/images/favicon_0.ico" />    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PSBN"></script>
    <script>dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','GTM-PSBN')</script>
  </head>
  <body class="article">
<header class="header" role="banner">
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="navbar-item">
                <a href="https://talend.github.io/component-runtime">Talend Component Kit</a>
                <span class="separator">//</span>
                <a href="https://talend.github.io/component-runtime">Docs</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="global-search">
                    <form role="search" action="search.html">
                        <div>
                            <input class="rounded" type="text" placeholder="Search" name="query" id="searchInput">
                            <input type="hidden" name="idx" value="githubantora">
                        </div>
                    </form>
                </div>
                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Projects</div>
                    <div class="navbar-dropdown">
                        <div class="navbar-item"><strong>API</strong></div>
                        <a class="navbar-item" href="https://github.com/talend/component-api">Repository</a>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><strong>Runtime</strong></div>
                        <a class="navbar-item" href="https://github.com/talend/component-rutime">Repository</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="main" data-version="0.0.4">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Talend Component Kit Developer Reference Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Programming Model</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-definition.html">Definition Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-registering.html">Registration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="gallery.html">Widget Gallery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-internationalization.html">Labels and i18n</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-loading.html">Loading</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Build</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="build-tools-maven.html">Maven</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="build-tools-gradle.html">Gradle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Services</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-internationalization.html">Internationalization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-actions.html">Actions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-built-in.html">Built-in services</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-interceptors.html">Interceptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-custom-api.html">Extend the API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Execute</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-pipeline.html">Simple/Test Pipeline API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://beam.apache.org/documentation/programming-guide/#creating-a-pipeline">Beam Pipeline API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Testing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-best-practices.html">JUnit Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-junit.html">Testing HTTP API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-beam.html">Beam case</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-spark.html">Spark and JUnit</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="testing-multiple-envs.html">Multiple environments for the same tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-maven-passwords.html">Secrets/Passwords and Maven</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-generating-data.html">Generating data?</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Web</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="documentation-rest.html">Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-generate-project-using-starter.html">Generate a component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-an-input-component.html">Create an input component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-an-output-component.html">Create an output component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-test-your-components.html">Test your components</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-configuration-sensitive-data.html">Configuration and sensitive data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-components-rest-api.html">Create components for REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-test-rest-api.html">How to test a REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-dev-vs-ci-setup.html">Dev vs CI setup</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Talend Component Kit Developer Reference Guide</span>
    <span class="version">0.0.4</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Talend Component Kit Developer Reference Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../1.0.1/index.html">1.0.1</a>
        </li>
        <li class="version">
          <a href="../1.0.0/index.html">1.0.0</a>
        </li>
        <li class="version">
          <a href="../0.0.12/index.html">0.0.12</a>
        </li>
        <li class="version">
          <a href="../0.0.11/index.html">0.0.11</a>
        </li>
        <li class="version">
          <a href="../0.0.10/index.html">0.0.10</a>
        </li>
        <li class="version">
          <a href="../0.0.9/index.html">0.0.9</a>
        </li>
        <li class="version">
          <a href="../0.0.8/index.html">0.0.8</a>
        </li>
        <li class="version">
          <a href="../0.0.7/index.html">0.0.7</a>
        </li>
        <li class="version">
          <a href="../0.0.6/index.html">0.0.6</a>
        </li>
        <li class="version">
          <a href="../0.0.5/index.html">0.0.5</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.0.4</a>
        </li>
        <li class="version">
          <a href="../0.0.3/index.html">0.0.3</a>
        </li>
        <li class="version">
          <a href="../0.0.2/index.html">0.0.2</a>
        </li>
        <li class="version">
          <a href="../0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
    <button class="navigation-toggle"></button>
    <nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Talend Component Kit Developer Reference Guide</a></li>
    <li class="crumb">Testing</li>
    <li class="crumb"><a href="testing-multiple-envs.html">Multiple environments for the same tests</a></li>
  </ul>
</nav>
    <div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">0.0.4</button>
  <div class="versions-menu">
    <a class="version" href="../1.0.1/testing-multiple-envs.html">1.0.1</a>
    <a class="version" href="../1.0.0/testing-multiple-envs.html">1.0.0</a>
    <a class="version" href="../0.0.12/testing-multiple-envs.html">0.0.12</a>
    <a class="version" href="../0.0.11/testing-multiple-envs.html">0.0.11</a>
    <a class="version" href="../0.0.10/testing-multiple-envs.html">0.0.10</a>
    <a class="version" href="../0.0.9/testing-multiple-envs.html">0.0.9</a>
    <a class="version" href="../0.0.8/testing-multiple-envs.html">0.0.8</a>
    <a class="version" href="../0.0.7/testing-multiple-envs.html">0.0.7</a>
    <a class="version" href="../0.0.6/testing-multiple-envs.html">0.0.6</a>
    <a class="version" href="../0.0.5/testing-multiple-envs.html">0.0.5</a>
    <a class="version is-current" href="testing-multiple-envs.html">0.0.4</a>
    <a class="version" href="../0.0.3/testing-multiple-envs.html">0.0.3</a>
    <a class="version" href="../0.0.2/testing-multiple-envs.html">0.0.2</a>
    <a class="version" href="../0.0.1/testing-multiple-envs.html">0.0.1</a>
  </div>
</div>
</div>
<article class="doc">
        <h1>Multiple environments for the same tests</h1>
        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>JUnit (4 or 5) already provides some ways to parameterized tests and execute the same "test logic"
against several data. However it is not that convenient to test multiple environments.</p>
</div>
<div class="paragraph">
<p>For instance, with Beam, you can desire to test against multiple runners your code
and it requires to solve conflicts between runner dependencies, setup the correct classloaders
etc&#8230;&#8203;It is a lot of work!</p>
</div>
<div class="paragraph">
<p>To simplify such cases, the framework provides you a multi-environment support for your tests.</p>
</div>
<div class="paragraph">
<p>It is in the junit module and is usable with JUnit 4 and JUnit 5.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_junit_4"><a class="anchor" href="#_junit_4"></a>1. JUnit 4</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RunWith(MultiEnvironmentsRunner.class)
@Environment(Env1.class)
@Environment(Env1.class)
public class TheTest {
    @Test
    public void test1() {
        // ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MultiEnvironmentsRunner</code> will execute the test(s) for each defined environments. It means it will
run <code>test1</code> for <code>Env1</code> and <code>Env2</code> in previous example.</p>
</div>
<div class="paragraph">
<p>By default <code>JUnit4</code> runner will be used to execute the tests in one environment but you can use <code>@DelegateRunWith</code>
to use another runner.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_junit_5"><a class="anchor" href="#_junit_5"></a>2. JUnit 5</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JUnit 5 configuration is close to JUnit 4 one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Environment(EnvironmentsExtensionTest.E1.class)
@Environment(EnvironmentsExtensionTest.E2.class)
class TheTest {

    @EnvironmentalTest
    void test1() {
        // ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main difference is you don&#8217;t use a runner (it doesn&#8217;t exist in JUnit 5) and you replace <code>@Test</code> by <code>@EnvironmentalTest</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
the main difference with JUnit 4 integration is that the tests are execute one after each other for all environments
instead of running all tests in each environments sequentially. It means, for instance, that <code>@BeforeAll</code> and <code>@AfterAll</code> are executed
once for all runners.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_provided_environments"><a class="anchor" href="#_provided_environments"></a>3. Provided environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The provided environment setup the contextual classloader to load the related runner of Apache Beam.</p>
</div>
<div class="paragraph">
<p>Package: <code>org.talend.sdk.component.junit.environment.builtin.beam</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the configuration is read from system properties, environment variables, &#8230;&#8203;.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all table-striped table-hover table-ordered">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Class</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ContextualEnvironment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contextual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contextual runner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DirectRunnerEnvironment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct runner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlinkRunnerEnvironment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flink</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flink runner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SparkRunnerEnvironment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spark runner</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_environments"><a class="anchor" href="#_configuring_environments"></a>4. Configuring environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the environment extends <code>BaseEnvironmentProvider</code> and therefore defines an environment name - which is the case of the default ones, you can use <code>EnvironmentConfiguration</code>
to customize the system properties used for that environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Environment(DirectRunnerEnvironment.class)
@EnvironmentConfiguration(
    environment = "Direct",
    systemProperties = @EnvironmentConfiguration.Property(key = "beamTestPipelineOptions", value = "..."))

@Environment(SparkRunnerEnvironment.class)
@EnvironmentConfiguration(
    environment = "Spark",
    systemProperties = @EnvironmentConfiguration.Property(key = "beamTestPipelineOptions", value = "..."))

@Environment(FlinkRunnerEnvironment.class)
@EnvironmentConfiguration(
    environment = "Flink",
    systemProperties = @EnvironmentConfiguration.Property(key = "beamTestPipelineOptions", value = "..."))
class MyBeamTest {

    @EnvironmentalTest
    void execute() {
        // run some pipeline
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
if you set the system property <code>&lt;environment name&gt;.skip=true</code> then the environment related executions will be skipped.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_advanced_usage"><a class="anchor" href="#_advanced_usage"></a>4.1. Advanced usage</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
this usage assumes Beam 2.4.0 is in used and the classloader fix about the <code>PipelineOptions</code> is merged.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.talend.sdk.component&lt;/groupId&gt;
    &lt;artifactId&gt;component-runtime-junit&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
    &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.jboss.shrinkwrap.resolver&lt;/groupId&gt;
    &lt;artifactId&gt;shrinkwrap-resolver-impl-maven&lt;/artifactId&gt;
    &lt;version&gt;3.0.1&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.talend.sdk.component&lt;/groupId&gt;
    &lt;artifactId&gt;component-runtime-beam&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.talend.sdk.component&lt;/groupId&gt;
    &lt;artifactId&gt;component-runtime-standalone&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These dependencies brings into the test scope the JUnit testing toolkit,
the Beam integration and the multi-environment testing toolkit for JUnit.</p>
</div>
<div class="paragraph">
<p>Then using the fluent DSL to define jobs - which assumes your job is linear and
each step sends a single value (no multi-input/multi-output), you can write this kind of test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Environment(ContextualEnvironment.class)
@Environment(DirectRunnerEnvironment.class)
class TheComponentTest {
    @EnvironmentalTest
    void testWithStandaloneAndBeamEnvironments() {
        from("myfamily://in?config=xxxx")
            .to("myfamily://out")
            .create()
            .execute();
        // add asserts on the output if needed
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will execute the chain twice:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>with a standalone environment to simulate the studio</p>
</li>
<li>
<p>with a beam (direct runner) environment to ensure the portability of your job</p>
</li>
</ol>
</div>
</div>
</div>
</div>
    </article>
  </main>
</div>
<footer class="footer">
    <div class="footer-with-copyright footer-with-links">
        <ul class="footer-links" style="">
            <li><a class="gwt-Anchor" href="http://www.talend.com/">Talend</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/contact">Contact</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/legal-terms/us-eula">Talend EULA</a></li>
        </ul>
        <div class="footer-copyright" style="">&copy; 2018 Talend Inc. All rights reserved.</div>
    </div>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script>
(function (window, document) {
  var closedSize = '50px';
  document.querySelectorAll('.listingblock')
    .forEach(function (listingblock, index) {
      var pre = listingblock.querySelector('div.content > pre.highlightjs.highlight');
      if (!pre) {return;}
      var code = pre.querySelector('code.hljs');
      if (!code) {return;}

      var span = document.createElement('span');
      var initialBlockClosed = listingblock.className.indexOf('initial-block-closed') >= 0;
      span.className = 'code-' + (initialBlockClosed ? 'collapsed' : 'open') + '-handle code-handle-base';

      var height = code.style.height;
      if (initialBlockClosed) {code.style.height = closedSize;}

      span.addEventListener('click', function () {
        if (span.className == 'code-collapsed-handle code-handle-base') {
          code.style.height = height;
          span.className = 'code-open-handle code-handle-base';
        } else {
          code.style.height = closedSize;
          span.className = 'code-collapsed-handle code-handle-base';
        }
      }, false);

      pre.prepend(span);
    });
})(window, document);
</script>
  </body>
</html>
